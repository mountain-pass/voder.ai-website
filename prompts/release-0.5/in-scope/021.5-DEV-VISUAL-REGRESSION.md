# DEV-VISUAL-REGRESSION: Visual Regression Testing Pipeline

## Release Goal

_"Release 0.5: Problem Validation - Ensure visual consistency and design validation"_

Implement GitHub Actions visual regression testing workflow using Playwright that performs automated screenshot testing, visual consistency validation, and design regression detection. This workflow runs after production build validation and provides comprehensive visual validation.

## How This Story Contributes

This story ensures visual consistency and design integrity by implementing a specialized visual regression testing pipeline that captures screenshots, compares visual changes, and validates design consistency across viewports and browsers. It provides critical visual quality gates to prevent design regressions.

## User Story

So that I can detect visual regressions and ensure consistent design across browsers and viewports, as a developer, I want a visual regression testing workflow that captures screenshots, compares visual changes, and validates design consistency after production builds are validated.

**INVEST Criteria Compliance**:

- **Independent**: ❌ DEPENDENT - Requires 021.3-DEV-CI-BUILD production build workflow to complete first for deployment artifacts
- **Negotiable**: ✅ Screenshot coverage, comparison thresholds, and visual validation criteria can be refined
- **Valuable**: ✅ Prevents design regressions and ensures visual consistency across platforms
- **Estimable**: ✅ Clear scope focused on visual regression testing with screenshot comparison. Estimated 1 sprint
- **Small**: ✅ APPROPRIATELY SIZED - Single concern focused on visual regression testing with clear boundaries
- **Testable**: ✅ Success measured by screenshot capture, visual comparison, and regression detection

## Acceptance Criteria

- [ ] **Visual Regression Workflow**: ci-visual.yml workflow runs after production build validation
- [ ] **Screenshot Testing**: Automated screenshot capture using Playwright
- [ ] **Multi-Viewport Testing**: Screenshots across desktop, tablet, and mobile viewports
- [ ] **Cross-Browser Screenshots**: Visual testing on Chromium, Firefox, and WebKit
- [ ] **Visual Comparison**: Automated comparison with baseline screenshots
- [ ] **Regression Detection**: Detect and report visual changes and regressions
- [ ] **Screenshot Artifacts**: Preserve screenshots and comparison results
- [ ] **Workflow Dependencies**: Only runs after 021.3-DEV-CI-BUILD passes
- [ ] **Status Reporting**: Clear GitHub status for visual regression testing

## Requirements

### Visual Testing Framework

- **REQ-PLAYWRIGHT-SCREENSHOTS**: Playwright framework configured for screenshot testing
- **REQ-MULTI-VIEWPORT**: Screenshot testing across multiple viewport sizes:
  - Desktop: 1920x1080
  - Tablet: 768x1024
  - Mobile: 375x667
- **REQ-CROSS-BROWSER-VISUAL**: Visual testing across Chromium, Firefox, and WebKit
- **REQ-BASELINE-MANAGEMENT**: Manage baseline screenshots for comparison

### Visual Comparison and Regression Detection

- **REQ-VISUAL-COMPARISON**: Automated pixel-level comparison with baseline images
- **REQ-REGRESSION-DETECTION**: Detect visual changes and flag regressions
- **REQ-COMPARISON-THRESHOLDS**: Configurable thresholds for acceptable visual differences
- **REQ-DIFF-REPORTING**: Generate visual diff reports showing changes

### Screenshot Management

- **REQ-SCREENSHOT-ARTIFACTS**: Preserve screenshot comparison results and visual diffs
- **REQ-BASELINE-STORAGE**: Store and manage baseline screenshots in repository
- **REQ-FAILURE-SCREENSHOTS**: Capture and store failure screenshots for debugging
- **REQ-CLI-ASSESSMENT**: Visual regression status verifiable via `gh run list` and `gh run view`

### Workflow Integration

- **REQ-WORKFLOW-DEPENDENCY**: Only runs after 021.3-DEV-CI-BUILD workflow succeeds
- **REQ-BUILD-ARTIFACT-USAGE**: Use production build artifacts from 021.3-DEV-CI-BUILD
- **REQ-BROWSER-CACHING**: Cache Playwright browsers for faster execution
- **REQ-PARALLEL-EXECUTION**: Run screenshot testing in parallel across browsers and viewports

## Dependencies

- 021.3-DEV-CI-BUILD (requires production build artifacts and validated deployment readiness)

## Implementation Notes

### Workflow Structure (ci-visual.yml)

```yaml
name: Visual Regression Testing
on:
  workflow_run:
    workflows: ['Production Build Validation']
    types: [completed]
    branches: [main]

jobs:
  visual-testing:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        viewport:
          - { width: 1920, height: 1080, name: 'desktop' }
          - { width: 768, height: 1024, name: 'tablet' }
          - { width: 375, height: 667, name: 'mobile' }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Download production build artifacts
      - name: Download production build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install ${{ matrix.browser }}

      - name: Run visual regression tests
        run: npm run screenshots -- --browser=${{ matrix.browser }} --viewport=${{ matrix.viewport.width }}x${{ matrix.viewport.height }}
        env:
          CI: true

      - name: Upload visual test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-results-${{ matrix.browser }}-${{ matrix.viewport.name }}
          path: |
            screenshots/
            visual-diff/
          retention-days: 30
```

### Screenshot Coverage

- **Page Coverage**: All main pages and critical user interface components
- **State Coverage**: Different application states (loading, error, success)
- **Component Coverage**: Key UI components and design elements
- **Responsive Coverage**: All responsive breakpoints and viewport sizes

### Visual Validation Areas

- **Layout Consistency**: Ensure layouts render consistently across browsers
- **Typography**: Validate font rendering and text appearance
- **Color Accuracy**: Ensure color schemes render correctly
- **Component Appearance**: Validate UI component visual integrity
- **Responsive Design**: Ensure responsive behavior works across viewports

### Integration with Other Workflows

- **Input**: Production build artifacts from 021.3-DEV-CI-BUILD
- **Parallel**: Can run in parallel with 021.4-DEV-E2E-TESTING
- **Output**: Visual test results and artifacts for deployment decision making
