# DEV-DEPLOY-PROTECTION: GitHub Actions Controlled Deployment Quality Gates

## Release Goal

_"Release 0.5: Problem Validation - Ensure only quality-validated code reaches production"_

Implement GitHub Actions controlled deployment that prevents broken deployments while maintaining trunk-based development workflow, ensuring founders only see high-quality validation experiences. This story corrects the misconception that Vercel provides CI-based deployment blocking and implements the correct approach using GitHub Actions to control when deployments occur.

## How This Story Contributes

This story ensures deployment reliability by creating quality gates in GitHub Actions that control when deployments are triggered, preventing broken code from reaching production without requiring branch protection rules. It maintains the fast feedback loop of trunk-based development while preventing failed CI from deploying broken experiences to founders testing our validation hypothesis.

## User Story

So that I can maintain rapid deployment cycles without risking broken experiences for founder validation sessions, as a developer, I want GitHub Actions to control deployments so that only successful CI builds trigger deployment to Vercel, while still allowing direct commits to main branch.

**INVEST Criteria Compliance**:

- **Independent**: ❌ DEPENDENT - Requires completion of CI pipeline stories (021.1, 021.2, 021.3) and changes to existing Vercel deployment approach
- **Negotiable**: ✅ Protection rules, workflow dependencies, and deployment verification methods can be refined
- **Valuable**: ✅ Prevents production breakages that could invalidate founder feedback and enables controlled deployment
- **Estimable**: ⚠️ MODERATE - Requires understanding GitHub Actions workflow dependencies and Vercel CLI integration. Estimated 1-2 sprints
- **Small**: ❌ MEDIUM - Involves disabling automatic deployments, creating new GitHub Actions workflows, implementing workflow dependencies, and deployment verification. More complex than simple configuration
- **Testable**: ✅ Success measured by deployment blocking when CI fails and successful deployments when CI passes

## Acceptance Criteria

**Note**: Vercel's "Deployment Protection" feature is for ACCESS control (authentication, passwords), NOT for blocking deployments based on CI status. Per [Vercel's documentation](https://vercel.com/docs/security/deployment-protection), this feature "safeguards both your preview and production URLs" through authentication, not CI integration.

- [ ] **Automatic Deployment Disabled**: Vercel automatic deployments from GitHub pushes are disabled (`git.deploymentEnabled: false`)
- [ ] **GitHub Actions Controlled**: GitHub Actions workflow triggers Vercel deployment only after successful CI
- [ ] **Quality Gate Integration**: All CI checks (lint, test, build, security) must pass before deployment is triggered
- [ ] **Deployment Success Verification**: Deployment process verifies successful completion using Vercel CLI (`vercel ls` and `vercel inspect`)
- [ ] **Trunk-Based Compatibility**: Works with direct commits to main branch (no branch protection required)
- [ ] **Preview Deployments**: Pull request preview deployments can be triggered manually or automatically on PR creation
- [ ] **Manual Override**: Emergency deployment capability through manual GitHub Actions trigger
- [ ] **Status Visibility**: Clear deployment status in GitHub Actions with Vercel deployment URLs
- [ ] **Fast Feedback**: Deployment starts immediately after successful CI completion
- [ ] **Rollback Capability**: Failed deployments can be quickly rolled back through Vercel dashboard or CLI
- [ ] **Vercel CLI Status Verification**: Use `vercel ls` to list deployments and `vercel inspect <deployment-url>` to verify the deployment is healthy and successful

## Requirements

### Core Protection Requirements

**Vercel's Role**: Per [Vercel GitHub Integration docs](https://vercel.com/docs/git/vercel-for-github), "Vercel for GitHub will deploy every push by default." Our approach disables this automatic behavior and uses GitHub Actions to control when deployments occur.

- **REQ-DISABLE-AUTO-DEPLOY**: Disable Vercel automatic deployments using `git.deploymentEnabled: false` in vercel.json
- **REQ-CI-CONTROLLED-DEPLOY**: GitHub Actions triggers Vercel deployment only after successful completion of all required workflows:
  - `CI Fast Feedback` (from 021.1-DEV-CI-CORE)
  - `Security Scan` (from 021.2-DEV-CI-SECURITY)
  - `Comprehensive Validation` (from 021.3-DEV-CI-COMPREHENSIVE)
- **REQ-QUALITY-BLOCKING**: Failed CI checks (lint, test, build, security, E2E) prevent GitHub Actions from triggering deployment
- **REQ-DEPLOYMENT-VERIFICATION**: GitHub Actions deployment step MUST verify actual deployment success using Vercel CLI commands (`vercel ls`, `vercel inspect`) and fail the workflow if deployment fails
- **REQ-ACTUAL-DEPLOY-STATUS**: GitHub Actions MUST detect and report actual Vercel deployment failures, not just command execution. Failed deployments must be clearly identified and the workflow must fail
- **REQ-TRUNK-COMPATIBLE**: No branch protection rules required - works with direct main commits
- **REQ-GITHUB-CONTROL**: All quality validation and deployment triggering happens in GitHub Actions - Vercel only builds and hosts
- **REQ-STATUS-CHECKS**: GitHub Actions coordinates all workflows from CI pipeline stories:
  - `CI Fast Feedback` (from 021.1-DEV-CI-CORE: TypeScript, ESLint, Prettier, unit tests, basic build)
  - `Security Scan` (from 021.2-DEV-CI-SECURITY: npm audit, secret scanning, CodeQL)
  - `Comprehensive Validation` (from 021.3-DEV-CI-COMPREHENSIVE: E2E tests, visual regression, production build)
- **REQ-CLI-VERIFICATION**: Use GitHub CLI (`gh run list`, `gh run view`) to verify workflow status and Vercel CLI (`vercel ls`, `vercel inspect`) to verify actual deployment status
- **REQ-DEPLOYMENT-FAILURE-DETECTION**: GitHub Actions MUST distinguish between CI failures (which block deployment trigger) and deployment failures (which occur during Vercel deployment execution)

### Deployment Control Requirements

- **REQ-PRODUCTION-ONLY**: Protection applies only to production deployments (not preview)
- **REQ-EMERGENCY-OVERRIDE**: Manual deployment trigger for critical fixes
- **REQ-TIMEOUT-HANDLING**: Deployment proceeds if CI takes longer than threshold (15 minutes)
- **REQ-PARTIAL-FAILURE**: Define which CI failures are blocking vs. warning-only

### Integration Requirements

- **REQ-VERCEL-CONFIG**: Configure Vercel deployment protection via vercel.json or dashboard
- **REQ-GITHUB-WEBHOOK**: GitHub status check webhook integration with Vercel
- **REQ-STATUS-REPORTING**: Clear status reporting in both Vercel and GitHub interfaces
- **REQ-NOTIFICATION**: Team notifications for blocked deployments

### Performance Requirements

- **REQ-DEPLOY-SPEED**: Successful deployments start within 30 seconds of CI completion
- **REQ-STATUS-LATENCY**: Status check results propagate to Vercel within 60 seconds
- **REQ-ROLLBACK-SPEED**: Failed deployments can be rolled back within 2 minutes

### Monitoring Requirements

- **REQ-DEPLOY-METRICS**: Track deployment success/failure rates
- **REQ-DEPLOY-VERIFICATION**: Monitor and log actual deployment completion status for every push - verify real Vercel deployment outcome, not just CI status
- **REQ-DEPLOYMENT-STATUS-TRACKING**: Continuously monitor actual deployment status and distinguish between different failure types (CI failure vs deployment failure vs runtime failure)
- **REQ-BLOCK-TRACKING**: Monitor how often deployments are blocked by quality gates
- **REQ-CI-TIMING**: Track CI completion times to optimize timeout thresholds
- **REQ-ALERT-SYSTEM**: Automated alerts for deployment protection failures AND actual deployment failures
- **REQ-REAL-TIME-STATUS**: Provide real-time deployment status visibility showing actual Vercel deployment state, not just GitHub Actions state

## Implementation Approach

**IMPORTANT**: After researching [Vercel's official documentation](https://vercel.com/docs/security/deployment-protection), "Deployment Protection" refers to ACCESS control (authentication, passwords, IP restrictions), NOT CI-based deployment blocking. The configuration in our current `vercel.json` with `deploymentStatus: "deployment_protection"` and `requiredStatusChecks` either doesn't exist as documented or doesn't work as expected.

### GitHub Actions Controlled Deployment (Correct Approach)

Per [Vercel's GitHub Actions documentation](https://vercel.com/docs/git/vercel-for-github#using-github-actions), this is the supported method for custom CI/CD workflows:

- **Disable automatic Vercel deployments** using `git.deploymentEnabled: false`
- **GitHub Actions triggers Vercel deployment** only after successful CI using `vercel deploy`
- **Add deployment verification** to confirm successful deployment using `vercel inspect`
- **Full control over deployment timing** while maintaining simplicity
- **Documented and supported** approach by Vercel

### Alternative: Repository Dispatch Events

Vercel provides [repository_dispatch events](https://vercel.com/docs/git/vercel-for-github#repository-dispatch-events) that trigger on deployment status changes, but this is for triggering GitHub Actions FROM Vercel deployments, not the reverse.

### Why Other Options Don't Work

- **Vercel Status Check Integration**: Not documented as a standard feature
- **Webhook-Based Protection**: Would require custom infrastructure when GitHub Actions provides the needed control

### Deployment Verification Implementation

**Verification Methods:**

- **GitHub Actions Integration**: Add deployment verification step to existing workflows
- **GitHub CLI Verification**: Use `gh run list --branch main` and `gh run view` to verify actual workflow execution status
- **Vercel CLI Verification**: Use `vercel ls` to list deployments and `vercel inspect <deployment-url>` to verify actual deployment status and health
- **Health Check Endpoint**: Verify deployed application responds correctly
- **Deployment Status API**: Monitor Vercel deployment status via API

**Success Criteria:**

- Deployment completes without errors (verified via `vercel inspect`)
- GitHub Actions workflows complete successfully (verified via `gh run view`)
- Application health check passes
- New deployment URL returns 200 status
- Critical functionality verified through smoke tests

## Dependencies

- 014.0-DEV-DEPLOY (requires existing Vercel deployment setup)
- 021.1-DEV-CI-CORE (requires fast feedback CI workflow for basic quality checks)
- 021.2-DEV-CI-SECURITY (requires security workflows for vulnerability scanning)
- 021.3-DEV-CI-BUILD (requires production build validation and deployment readiness)
- 021.4-DEV-E2E-TESTING (requires comprehensive E2E testing validation)
- 021.5-DEV-VISUAL-REGRESSION (requires visual regression testing validation)
- 001.1-PO-DECISION-MANAGEMENT (architectural decision for protection approach)

## Pipeline Architecture

### Specialized Pipeline Approach

This story implements the final deployment step in a specialized pipeline:

```
┌─────────────────────┐    ┌─────────────────────┐
│ 021.1-DEV-CI-CORE   │    │ 021.2-DEV-CI-SECURITY │
│ Fast Feedback       │    │ Security Scan        │
│ (5-10 min)          │    │ (parallel)           │
│ • TypeScript        │    │ • npm audit          │
│ • ESLint           │    │ • Secret scanning    │
│ • Prettier         │    │ • CodeQL             │
│ • Unit tests       │    │                      │
│ • Basic build      │    │                      │
└─────────┬───────────┘    └─────────┬───────────┘
          │                          │
          └─────────┬──────────────────┘
                    ▼
          ┌─────────────────────┐
          │ 021.3-DEV-CI-BUILD  │
          │ Production Build    │
          │ (5-10 min)          │
          │ • Production build  │
          │ • Deploy readiness  │
          │ • Build artifacts   │
          └─────────┬───────────┘
                    │
          ┌─────────┴─────────┬─────────────────────┐
          ▼                   ▼                     ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│ 021.4-DEV-E2E-TEST  │ │ 021.5-DEV-VISUAL    │ │ (Future workflows)  │
│ E2E Testing         │ │ Visual Regression   │ │                     │
│ (10-15 min)         │ │ (5-10 min)          │ │                     │
│ • Playwright tests  │ │ • Screenshots       │ │                     │
│ • Cross-browser     │ │ • Visual diff       │ │                     │
│ • User workflows    │ │ • Multi-viewport    │ │                     │
└─────────┬───────────┘ └─────────┬───────────┘ └─────────────────────┘
          │                       │
          └─────────┬─────────────┘
                    ▼
          ┌─────────────────────┐
          │ 022.0-DEV-DEPLOY    │
          │ Deployment          │
          │ • Vercel deploy     │
          │ • Verify success    │
          └─────────────────────┘
```

## Configuration Changes Required

### Vercel Project Settings (vercel.json)

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm ci",
  "git": {
    "deploymentEnabled": false
  }
}
```

**Key Changes**:

- **Remove** `github.deploymentStatus` and `github.requiredStatusChecks` (these don't work as expected)
- **Add** `git.deploymentEnabled: false` to disable automatic deployments
- **Keep** minimal build configuration since GitHub Actions handles quality checks

### GitHub Actions Deployment Workflow

Add to existing workflow or create new deployment workflow:

```yaml
name: Deploy to Production
on:
  push:
    branches: [main]

jobs:
  # Wait for all required workflows to complete
  check-required-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI Fast Feedback
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: CI Fast Feedback
          ref: ${{ github.sha }}
      - name: Wait for Security Scan
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Security Scan
          ref: ${{ github.sha }}
      - name: Wait for Comprehensive Validation
        uses: fountainhead/action-wait-for-check@v1.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Comprehensive Validation
          ref: ${{ github.sha }}

  deploy:
    needs: check-required-workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Deploy to Vercel
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Verify Deployment
        run: |
          DEPLOYMENT_URL=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} | head -n 1 | awk '{print $2}')
          vercel inspect $DEPLOYMENT_URL --token=${{ secrets.VERCEL_TOKEN }}
```

**Reference**: [How to use GitHub Actions with Vercel](https://vercel.com/guides/how-can-i-use-github-actions-with-vercel)

## Success Metrics

- **Zero broken deployments** reaching production when CI fails
- **Sub-30-second deployment start** after successful CI
- **100% compatibility** with trunk-based development workflow
- **Emergency override** capability tested and documented
