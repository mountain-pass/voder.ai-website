# 024.0-DEV-DEPLOY-VERIFY-ROLLBACK: Post-Deployment Verification and Automatic Rollback

## Release Goal

_"Release 0.5: Essential Dev Experience - Establish production verification with automatic rollback for confident trunk-based development deployment"_

Implement post-deployment verification checks with automatic rollback capability, enabling safe high-frequency deployments to production by automatically detecting and recovering from deployment failures within 60 seconds.

## How This Story Contributes

This story completes the deployment safety net for trunk-based development by adding post-deployment verification and automatic recovery. Combined with pre-deployment quality gates (023.0), it enables the DORA-style high deployment frequency with confidence that issues will be automatically detected and rolled back, supporting the "fail fast, recover fast" principle essential for continuous deployment.

## User Story

So that I can deploy frequently with confidence and automatically recover from production issues, as a developer, I want post-deployment verification that monitors the deployed application and automatically rolls back to the previous version if health checks fail.

**INVEST Criteria Compliance**:

- **Independent**: Builds on quality gates (023.0) and deployment (022.0) without changing their logic
- **Negotiable**: Specific verification checks and rollback triggers can be refined during implementation
- **Valuable**: Provides automatic recovery from deployment failures, critical for trunk-based development
- **Estimable**: Clear scope - add verification job with rollback capability to existing workflow
- **Small**: Single workflow job addition with clear verification and rollback logic
- **Testable**: Can verify health checks work, rollback triggers correctly, and rollback completes successfully

## Acceptance Criteria

- [ ] **Health Check Verification**: HTTP status checks, response time validation, and basic functionality verification
- [ ] **Automatic Rollback Trigger**: Failed verification automatically triggers rollback to previous deployment
- [ ] **Rollback Speed**: Rollback completes within 60 seconds of failure detection
- [ ] **Verification Duration**: Health checks run for 2 minutes before declaring deployment successful
- [ ] **Clear Status Reporting**: Verification and rollback status clearly reported in GitHub Actions and notifications
- [ ] **Previous Deployment Detection**: Automatically identify and rollback to the last known good deployment
- [ ] **Manual Override Capability**: Ability to skip automatic rollback for known/acceptable issues

## Requirements

### Verification Implementation

- **REQ-HEALTH-CHECKS**: HTTP status verification, response time checks, and basic functionality validation
- **REQ-VERIFICATION-DURATION**: Run verification checks for 2 minutes with multiple check intervals
- **REQ-FAILURE-DETECTION**: Detect various failure types including HTTP errors, timeouts, and response issues
- **REQ-SUCCESS-CRITERIA**: Clear criteria for when verification passes and deployment is considered successful

### Rollback Implementation

- **REQ-AUTOMATIC-ROLLBACK**: Failed verification automatically triggers rollback without manual intervention
- **REQ-ROLLBACK-SPEED**: Complete rollback process within 60 seconds of failure detection
- **REQ-PREVIOUS-DEPLOYMENT**: Automatically identify and promote the last successful deployment
- **REQ-ROLLBACK-VERIFICATION**: Verify rollback deployment is healthy after rollback completion

### Status Reporting and Notifications

- **REQ-CLEAR-STATUS**: Verification and rollback status clearly visible in GitHub Actions UI
- **REQ-FAILURE-DETAILS**: Specific details about what verification checks failed and why
- **REQ-ROLLBACK-NOTIFICATIONS**: Clear notifications when automatic rollback occurs
- **REQ-SUCCESS-CONFIRMATION**: Confirmation when verification passes and deployment is stable

### Integration with Deployment Pipeline

- **REQ-DEPLOYMENT-URL**: Use deployment URL from previous deployment job for verification
- **REQ-DEPLOYMENT-CLI-INTEGRATION**: Use deployment platform CLI commands for rollback operations
- **REQ-JOB-DEPENDENCY**: Verification job depends on successful deployment job completion
- **REQ-WORKFLOW-CONTINUATION**: Workflow completes successfully after verification or rollback

### Compliance with Architectural Decisions

- **IMPL-DORA-RECOVERY**: Implements ADR-0024 trunk-based development with fast recovery capability
- **IMPL-DEPLOYMENT-VERIFICATION**: Extends deployment pipeline with verification and rollback capabilities
- **IMPL-DEPLOYMENT-CLI**: Uses deployment platform CLI for deployment management and rollback operations

## Dependencies

- 023.0-DEV-DEPLOY-QUALITY-GATES (quality gates must exist to prevent bad deployments in the first place)
- 022.0-DEV-DEPLOY-SIMPLE (working deployment to verify and rollback from)

## Technical Implementation Notes

### Verification Workflow Structure

```yaml
verify-and-rollback:
  needs: deploy
  runs-on: ubuntu-latest
  steps:
    - name: Production Verification
      id: verify
      run: |
        DEPLOYMENT_URL="${{ needs.deploy.outputs.deployment_url }}"

        # Health checks over 2 minutes
        for i in {1..12}; do
          if curl -f --max-time 10 "$DEPLOYMENT_URL" > /dev/null 2>&1; then
            echo "✅ Health check $i passed"
            sleep 10
          else
            echo "❌ Health check $i failed"
            echo "rollback_needed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
        done
        echo "✅ All verification checks passed"

    - name: Automatic Rollback
      if: failure() && steps.verify.outputs.rollback_needed == 'true'
      run: |
        echo "🔄 Triggering automatic rollback..."
        # Use deployment platform CLI to identify and promote previous deployment
        PREV_DEPLOYMENT=$(deployment-cli list --token ${{ secrets.DEPLOYMENT_TOKEN }} | sed -n '2p' | awk '{print $2}')
        deployment-cli promote "$PREV_DEPLOYMENT" --token ${{ secrets.DEPLOYMENT_TOKEN }}
        echo "✅ Rollback completed to: $PREV_DEPLOYMENT"
```

### Verification Check Types

- **HTTP Status Verification**: Ensure deployment responds with successful HTTP status codes
- **Response Time Validation**: Verify response times are within acceptable limits
- **Basic Functionality**: Simple smoke tests for critical application functionality
- **SSL Certificate Validation**: Ensure HTTPS is working correctly
- **Core Resource Loading**: Verify critical assets (CSS, JS) load successfully

### Rollback Mechanism

- **Deployment History**: Use deployment platform CLI to identify previous successful deployments
- **Promotion-Based Rollback**: Use deployment platform's promote command to make previous deployment current
- **Rollback Verification**: Verify rolled-back deployment is healthy
- **Status Tracking**: Track rollback success and update GitHub status accordingly

### Error Handling

- **Verification Failure Detection**: Multiple failure types (HTTP errors, timeouts, response issues)
- **Rollback Failure Handling**: Handle cases where rollback itself fails
- **Manual Intervention Points**: Clear points where manual intervention may be needed
- **Escalation Procedures**: Clear documentation for when automatic systems cannot resolve issues

### Manual Override Mechanisms

- **Environment Variable**: `SKIP_AUTO_ROLLBACK=true` to disable automatic rollback
- **Workflow Input**: Manual dispatch option to skip rollback
- **Comment Triggers**: GitHub comment commands to control rollback behavior
- **Emergency Stop**: Mechanism to halt automatic rollback if needed
